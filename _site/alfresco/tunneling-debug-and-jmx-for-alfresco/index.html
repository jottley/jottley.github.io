<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Tunneling Debug and JMX for Alfresco &#8211; I exist as I am</title>
<meta name="description" content="">
<meta name="keywords" content="Alfresco, debug, JMX, SSH tunneling">
<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://jared.ottleys.net/images/">
<meta name="twitter:title" content="Tunneling Debug and JMX for Alfresco">
<meta name="twitter:description" content="Something Something Something">
<meta name="twitter:creator" content="@jottley">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Tunneling Debug and JMX for Alfresco">
<meta property="og:description" content="Something Something Something">
<meta property="og:url" content="http://jared.ottleys.net/alfresco/tunneling-debug-and-jmx-for-alfresco">
<meta property="og:site_name" content="I exist as I am">





<link rel="canonical" href="http://jared.ottleys.net/alfresco/tunneling-debug-and-jmx-for-alfresco">
<link href="http://jared.ottleys.net/feed.xml" type="application/atom+xml" rel="alternate" title="I exist as I am Feed">
<link rel="author" href="https://plus.google.com/u/0/116380333940951424604/posts?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://jared.ottleys.net/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="http://jared.ottleys.net/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->

<script src="http://jared.ottleys.net/assets/js/modernizr.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://jared.ottleys.net/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://jared.ottleys.net/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://jared.ottleys.net/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://jared.ottleys.net/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://jared.ottleys.net/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://jared.ottleys.net/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="article" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div id="outer-wrap">
<div id="inner-wrap">

    <header id="top" role="banner">
        <div class="block">
            <h1 class="block-title">I exist as I am</h1>
            <a class="nav-btn" id="nav-open-btn" href="#nav">Navigation</a>
        </div>
    </header>

    <nav id="nav" role="navigation">
        <div class="block">
            <h2 class="block-title">Chapters</h2>
            <ul>
                
				<li><a href="http://jared.ottleys.net/" >Home</a></li>
		        
				<li><a href="http://jared.ottleys.net/about/" >About</a></li>
		        
				<li><a href="http://jared.ottleys.net/articles/" >Articles</a></li>
		        
		        <li><a href="http://jared.ottleys.net/feed.xml" title="Atom/RSS feed">Feed</a>
            </ul>
            <a class="close-btn" id="nav-close-btn" href="#top">Return to Content</a>
        </div>
    </nav>



<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
  <div class="article-author-side">
    <img src="http://jared.ottleys.net/images/photo.JPG" class="bio-photo" alt="Jared Ottley bio photo"></a>
<h3>Jared Ottley</h3>
<p>Jared Ottley is an engineer at <a href='http://www.alfresco.com'>Alfresco</a>.  As the father of 6 he is raising a geek army. He has a degree in Political Science and drives a Mini.</p>
<a href="mailto:jared@ottleys.net" class="author-social"><i class="icon-mail"></i> jared@ottleys.net</a>
<a href="http://twitter.com/jottley" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="http://facebook.com/jottley" class="author-social" target="_blank"><i class="icon-facebook"></i> Facebook</a>
<a href="https://plus.google.com/u/0/116380333940951424604/posts" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>
<a href="http://linkedin.com/in/jottley" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://instagram.com/jaredtottley" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>
<a href="http://github.com/jottley" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>
<a href="http://lastfm.com/jottley" class="author-social" target="_blank"><i class="icon-lastfm"></i> Last.fm</a>
<a href="http://www.flickr.com/photos/jottley" class="author-social" target="_blank"><i class="icon-flickr"></i> Flickr</a>

  </div>
  <article itemscope itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
    <div class="headline-wrap">
      <h1 itemprop="name">Tunneling Debug and JMX for Alfresco</h1>
      <h2></h2>
    </div><!--/ .headline-wrap -->
    <div class="article-wrap" itemprop="text">
      <p><strong>UPDATE:</strong> As of 3.2 sp1 the custom-core-services-context.xml is no longer needed.  Check this [updated post][1] for more info.  You will also find supplementary instructions on using Windows there.</p>

<p>As we start to see more deployments of Alfresco in the cloud we are also seeing increased complexity in using features like JMX for managing Alfresco and troubleshooting Alfresco customizations with a Java debugger.  Below are two ways that you can use to enable both on cloud based installs of Alfresco.  These methods can also be used in instances where more security conscious admins have locked down ports, for example in a secured environment.  Also note these methods require an ssh client on your client machine and an ssh daemon on the server.  The instructions provided below assume you are using Linux on the server (which is likely to be the case for most cloud based installs); your client may run Windows, OS X or Linux.  Windows clients will require using ssh clients as provided by [cygwin][2] or [Putty][3], etc. Cygwin will allow you to use the following as described.  For putty, use this description of [tunneling with putty][4] along with the configuration instructions that follow.</p>

<h2 id="ssh-tunneling-for-debugging">SSH Tunneling for Debugging</h2>

<p>First configure Alfresco/Tomcat to listen for debug connections as per usual.  Add the following to your <code>alfresco.sh</code> file:</p>

<p><code>export JAVA_OPTS="${JAVA_OPTS} -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8082"</code></p>

<p>The <code>address</code> parameter sets the port you want the debugger to listen on.  Adding this line, will require you to restart Alfresco/tomcat for it to become active.</p>

<p>Next, standard port forwarding with ssh should enable Java debugging:</p>

<p><code>ssh -i path/to/your.pem -f root@yourhost.com -L 2000:localhost:8082 -N</code></p>

<p>In this example we are using the following options:</p>

<p style="padding-left: 30px">
  <strong><code>-i path/to/your.pem</code></strong> If you are using key-based authentication, like with EC2, use this option to point to your private key.  It is optional if you are not.
</p>

<p style="padding-left: 30px">
  <strong><code>-f</code> </strong>Have the session move into the background after you connect.  Useful if you need to enter a password or passphrase
</p>

<p style="padding-left: 30px">
  <strong><code>root@yourhost.com</code></strong> The user and name of the server to connect to.  You do not need to use your root user account.
</p>

<p style="padding-left: 30px">
  <strong><code>-L 2000:localhost:8082</code></strong> The first number is the local port that you want to open to listen to connections on. Next is the hostname/IP/DNS name of the server to connect to on the other side of the tunnel and then finally the port to connect to at that address.
</p>

<p style="padding-left: 30px">
  <strong><code>-N</code></strong> tells ssh to not execute a command upon connection
</p>

<p>Next we need to connect the debugger.  This example gives instructions for Eclipse.  Configure the debugger using the Remote Java Application option. Accept the default Connection Type: <code>Standard (Socket Attach)</code>, but for the Connection Properties enter <code>localhost</code> for the Host and the port number from the first parameter in the <code>-L</code> switch for Port.  In our example port <code>2000</code>.</p>

<div id="attachment_276" style="width: 387px" class="wp-caption aligncenter">
  <img class="size-full wp-image-276 " src="http://jared.ottleys.net/files/2010/02/dhnsnn76_21dt9jhkc7_b.png" alt="Eclipse Debugger" width="377" height="170" /><p class="wp-caption-text">
    Eclipse Debugger
  </p>
</div>

<p>Connect your debugger.</p>

<h2 id="ssh-tunneling-for-jmx">SSH Tunneling for JMX</h2>

<p>This configuration is a bit more complex due to how RMI works.</p>

<p>First, you will need to add the following line to your <code>alfresco.sh</code> file (Restart required to turn in on):</p>

<p><code>export JAVA_OPTS="${JAVA_OPTS} -Dcom.sun.management.jmxremote=true -Djava.rmi.server.hostname=dummyhost"</code></p>

<p>You may already see the <code>-Dcom.sun.management.jmxremote</code> line in the file, if so just add <code>=true</code> to it.  This is important as I’ve had difficulty attaching with out this set to true (even though the default value of that option, with out declaring the value is true).</p>

<p>The <code>-Djava.rmi.server.hostname=dummyhost</code> option is needed to help RMI know where to connect.  RMI connects in a two part process.  First by connecting to the RMI server registry, which pushes your request to the JMX service which is dynamically allocated on the first open port available to it at start up time. Dynamic ports don’t give us the consistence we need so we will want to configure Alfresco to use a static port. Also, this second connection requires us to use/set a hostname to connect, otherwise it will return an IP address, which in the case of EC2 is non-routable.</p>

<p>Let’s create a new context file under the <code>extension</code> directory (<code>tomcat/shared/classes/alfresco/extension</code>) and call it <code>custom-core-services-context.xml</code>.  In that file we will add the following:</p>

<p>`<?xml version='1.0' encoding='UTF-8'?><br />
&lt;!DOCTYPE beans PUBLIC ‘-//SPRING//DTD BEAN//EN’ ‘http://www.springframework.org/dtd/spring-beans.dtd’&gt;&lt;/p&gt;</p>
<p><beans>
<p><!-- MBeanServer Connector Override (registers itself with custom alfrescoMBeanServer) --><br />
&lt;bean id="serverConnector"<br />
depends-on="registry"<br />
lazy-init="true"&gt;</p>
<p><property name="server" ref="alfrescoMBeanServer" /><br />
&lt;property name="objectName"  value="connector:name=rmi"/&gt;<br />
&lt;property name="serviceUrl"  value="service:jmx:rmi://localhost:${jmx.port.number}/jndi/rmi://localhost:${alfresco.rmi.services.port}/alfresco/jmxrmi" /&gt;</p>
<p><property name="environment"><br />
<map><br />
<!-- The following keys are only valid when sun jmx is used --><br />
<entry key="jmx.remote.x.password.file" value="${alfresco.jmx.dir}/alfresco-jmxrmi.password" /><br />
&lt;entry key="jmx.remote.x.access.file"   value="${alfresco.jmx.dir}/alfresco-jmxrmi.access"/&gt;<br />
</map><br />
</property><br />
</p>
<p>`

The important value in here is `jmx.port.number`.  To set this value add `jmx.port.number=50508` to the `alfresco-global.properties` file (located in `tomcat/shared/classes`)

Next you will want to add the hostname you entered above into your `/etc/hosts file`:

`127.0.0.1    dummyhost`

Remember we do this because during the second part of establishing an RMI connection, RMI returns the hostname we want to connect to.  In our case this is the local client that is forwarding the connection to the server machine that is running Alfresco.

Now start Alfresco and let&#8217;s configure ssh to forward the ports.  This requires two new tunnels:

`ssh -i path/to/your.pem -f root@yourhost.com -L 2001:localhost:50500 -N`

`ssh -i path/to/your.pem -f root@yourhost.com -L dummyhost:50508:localhost:50508 -N`

The same explanations to these commands found in the debug section above apply here as well.  But notice one difference in the second tunnel.  The second tunnel is specifying the hostname to connect to: `dummyhost`.  Remember we are doing this because RMI will be returning the hostname as specified in our `alfresco.sh` file.  We need to tell the tunnel how to use that hostname.  Also, the port we want to have listening locally is the same as the port that will be listening remotely.

Finally, when you connect your JMX console to Alfresco use the standard connection string but for the hostname use `localhost` and the port number, `2001`, specified in the first tunnel:

`service:jmx:rmi:///jndi/rmi://localhost:2001/alfresco/jmxrmi`

 [1]: http://jared.ottleys.net/alfresco/updated-tunneling-debug-and-jmx-for-alfresco
 [2]: http://www.cygwin.com/
 [3]: http://www.chiark.greenend.org.uk/~sgtatham/putty/
 [4]: http://www.cs.uu.nl/technical/services/ssh/putty/puttyfw.html
</p></beans></p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          <img src="http://jared.ottleys.net/images/photo.JPG" class="bio-photo" alt="Jared Ottley bio photo"></a>
<h3>Jared Ottley</h3>
<p>Jared Ottley is an engineer at <a href='http://www.alfresco.com'>Alfresco</a>.  As the father of 6 he is raising a geek army. He has a degree in Political Science and drives a Mini.</p>
<a href="mailto:jared@ottleys.net" class="author-social"><i class="icon-mail"></i> jared@ottleys.net</a>
<a href="http://twitter.com/jottley" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="http://facebook.com/jottley" class="author-social" target="_blank"><i class="icon-facebook"></i> Facebook</a>
<a href="https://plus.google.com/u/0/116380333940951424604/posts" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>
<a href="http://linkedin.com/in/jottley" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="http://instagram.com/jaredtottley" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>
<a href="http://github.com/jottley" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>
<a href="http://lastfm.com/jottley" class="author-social" target="_blank"><i class="icon-lastfm"></i> Last.fm</a>
<a href="http://www.flickr.com/photos/jottley" class="author-social" target="_blank"><i class="icon-flickr"></i> Flickr</a>

        </div>
        <p class="byline"><strong>Tunneling Debug and JMX for Alfresco</strong> was published on <time datetime="2010-02-16T00:00:00-07:00" itemprop="datePublished">February 16, 2010</time> by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="http://jared.ottleys.net/about" title="About Jared Ottley" itemprop="url">Jared Ottley</a></span></span>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://jared.ottleys.net/articles">View all articles</a>)</small></h4>
    <ul>
    
      
      
        
          
        
      
      
      <li><a href="http://jared.ottleys.net/alfresco/alfresco-property-decorators-cont" title="Alfresco: Property Decorators &#8212; cont.">Alfresco: Property Decorators &#8212; cont.</a></li>
      
    
      
      
        
          
        
      
      
      <li><a href="http://jared.ottleys.net/alfresco/alfresco-simple-workflow-web-scripts" title="Alfresco: Simple Workflow Web Scripts">Alfresco: Simple Workflow Web Scripts</a></li>
      
    
      
      
        
          
        
      
      
      <li><a href="http://jared.ottleys.net/alfresco/alfresco-simple-workflow" title="Alfresco: Simple Workflow">Alfresco: Simple Workflow</a></li>
      
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    <span>&copy; 2014 Jared Ottley. The thoughts here are my own and are not my employers...so blame me.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://jared.ottleys.net/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://jared.ottleys.net/assets/js/scripts.min.js"></script>
<script src="http://jared.ottleys.net/assets/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-73397-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
	        

</body>
</html>
